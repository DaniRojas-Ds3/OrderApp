<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Panel de Administraci√≥n</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

  <style>
    /* üåà ESTILO GENERAL */
    body {
      margin: 0;
      padding: 0;
      font-family: 'Segoe UI', Tahoma, sans-serif;
      background: linear-gradient(135deg, #ffcf70, #fadda4);
      height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .admin-container {
      text-align: center;
      background: white;
      padding: 40px 60px;
      border-radius: 20px;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.2);
    }

    .admin-container h1 {
      color: #333;
      margin-bottom: 25px;
    }

    button {
      background: #d62828;
      color: white;
      border: none;
      padding: 15px 30px;
      font-size: 18px;
      border-radius: 14px;
      cursor: pointer;
      width: 260px;
      margin: 12px;
      box-shadow: 0 4px 10px rgba(0,0,0,0.15);
      transition: all 0.25s ease;
    }

    button:hover {
      background: #ff914d;
      transform: translateY(-3px);
      box-shadow: 0 6px 14px rgba(0,0,0,0.20);
    }

    .back-button{
      position: fixed;
      top: 170px;
      right: 10px;
      z-index: 1000;
    }

    .back-button a{
      display: inline-flex;
      align-items:center;
      justify-content:center;
      width: 10px;
      height: 10px;
      background-color: white;
      color: rgb(0, 0, 0);
      text-decoration:none;
      padding: 12px 20px;
      border: 1px solid black;
      border-radius: 45px;
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
      transition: all 0.3s ease;
    }

    .back-button .arrow{
      font-size: 3rem;
      display: block;
      transform: translateY(-6px);
    }

    .back-button a:hover{
      transform: scale(1.1);
    }
  </style>
</head>

<body>

  <!-- BOT√ìN DE REGRESO -->
  <div class="back-button">
    <a href="index.html"><span class="arrow">‚Üê</span></a>
  </div>

  <div class="admin-container">
    <h1>Panel de Administraci√≥n</h1>

    <button id="pdfBtn">üìÑ Generar Resumen Reservas</button>
    <button id="pqrBtn">üìÑ Generar Resumen PQRS</button>
  </div>

  <script type="module">

    // üåê URL de tu WebApp de Google Apps Script
    const WEBAPP_URL = "https://script.google.com/macros/s/AKfycby4gZuX2NTgJaOZttrV7-_P7ZMX4FPxccCvoWI3irZtEaYzhn9bT1FStnoClzvOEAB6Dw/exec";

/* ==================================================
   üìÑ PDF RESERVAS (con salto autom√°tico de p√°gina)
   ================================================== */

// Importar Firebase desde tu archivo firebase.js
import { db } from "./firebase.js";
import { 
  collection, 
  getDocs,
  query,
  orderBy
} from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";


// üî• Funci√≥n para traer reservas desde Firestore
async function cargarReservasDesdeFirestore() {
  const reservasRef = collection(db, "reservas");
  const q = query(reservasRef, orderBy("fechaCreacion", "desc"));
  const querySnapshot = await getDocs(q);

  const data = [];

  querySnapshot.forEach(doc => {
    const item = doc.data();

    // üî• Convertir timestamp correctamente
    if (item.fechaCreacion && item.fechaCreacion.toDate) {
      item.fechaCreacion = item.fechaCreacion.toDate();
    }

    data.push(item);
  });

  return data;
}


// ------------------- FIN CARGA DE RESERVAS ------------------------------//


const pdfBtn = document.getElementById("pdfBtn");

pdfBtn.addEventListener("click", async () => {

        const { jsPDF } = window.jspdf;

        // üìÑ TAMA√ëO CARTA REAL + COORDENADAS EN PUNTOS
        const doc = new jsPDF({
            unit: "pt",
            format: "letter"
        });

        // üëâ Funci√≥n para saltar p√°gina
        function checkPageLimit() {
            if (y >= 750) {       // l√≠mite para carta
                doc.addPage();
                y = 40;
            }
        }

        // -------- ENCABEZADO --------
        doc.setFont("helvetica", "bold");
        doc.setFontSize(18);
        doc.text("RESUMEN DE RESERVAS", 40, 40);

        const fecha = new Date().toLocaleDateString("es-CO", {
            year: "numeric",
            month: "long",
            day: "numeric"
        });

        doc.setFontSize(12);
        doc.text(`Fecha del reporte: ${fecha}`, 40, 60);

        // üî• Cargar reservas
        const reservas = await cargarReservasDesdeFirestore();

        const hoy = new Date().toLocaleDateString("es-CO");
        const reservasDeHoy = reservas.filter(r => r.fecha === hoy);

        if (reservasDeHoy.length === 0) {
            doc.text("No hay reservas registradas para hoy.", 40, 80);
            doc.save(`resumen_reservas_${fecha}.pdf`);
            return;
        }

        let y = 90;

        // ======================================================
        // üî• TOTAL GENERAL DE PRODUCTOS
        // ======================================================
        const totalGeneral = {};
        reservasDeHoy.forEach(r => {
            if (!totalGeneral[r.producto]) totalGeneral[r.producto] = 0;
            totalGeneral[r.producto] += r.cantidad;
        });

        doc.setFont("helvetica", "bold");
        doc.text("TOTAL GENERAL DE PRODUCTOS:", 40, y);
        y += 20;

        doc.setFont("helvetica", "normal");

        for (const [producto, cantidad] of Object.entries(totalGeneral)) {
            checkPageLimit();
            doc.text(`‚Ä¢ ${cantidad} ${producto}`, 50, y);
            y += 16;
        }

        y += 20;

        // ======================================================
        // üî• AGRUPAR POR JORNADAS (ORDEN PERSONALIZADO)
        // ======================================================
        const ordenJornadas = [
            "Jornada Externa",
            "Ma√±ana",
            "Tarde",
            "Noche"
        ];

        const jornadas = {};
        reservasDeHoy.forEach(r => {
            if (!jornadas[r.jornada]) jornadas[r.jornada] = [];
            jornadas[r.jornada].push(r);
        });

        for (const jornada of ordenJornadas) {

            if (!jornadas[jornada]) continue;

            checkPageLimit();
            doc.setFont("helvetica", "bold");
            doc.text(`Jornada: ${jornada}`, 40, y);
            y += 20;

            doc.setFont("helvetica", "normal");

            // üëâ Totales por jornada
            const productosJornada = {};
            jornadas[jornada].forEach(r => {
                if (!productosJornada[r.producto]) productosJornada[r.producto] = 0;
                productosJornada[r.producto] += r.cantidad;
            });

            for (const [producto, cantidad] of Object.entries(productosJornada)) {
                checkPageLimit();
                doc.text(`‚Ä¢ ${cantidad} ${producto}`, 50, y);
                y += 16;
            }

            y += 12;

            // üëâ Agrupaci√≥n por usuario
            const usuarios = {};
            jornadas[jornada].forEach(r => {
                if (!usuarios[r.usuario]) usuarios[r.usuario] = {};
                if (!usuarios[r.usuario][r.producto]) usuarios[r.usuario][r.producto] = 0;
                usuarios[r.usuario][r.producto] += r.cantidad;
            });

// üëâ Imprimir cada usuario con productos en lista
for (const [usuario, pedidos] of Object.entries(usuarios)) {

    // Antes de imprimir usuario ‚Üí verificar salto
    checkPageLimit();
    doc.text(`- ${usuario}:`, 30, y);
    y += 15;

    // Lista de productos bajo el usuario
    for (const [prod, cant] of Object.entries(pedidos)) {

        checkPageLimit(); // evita que se corte la l√≠nea

        doc.text(`‚Ä¢ ${cant} ${prod}`, 45, y);
        y += 14;
    }

    y += 12; // espacio entre usuarios
}
        }

        doc.save(`resumen_reservas_${fecha}.pdf`);
});

    /* ==================================================
       ‚≠ê PDF PQRS DESDE GOOGLE SHEETS (CORREGIDO)
       ================================================== */

    const pqrBtn = document.getElementById("pqrBtn");

    pqrBtn.addEventListener("click", async () => {
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF();

      function line(y) {
        doc.setDrawColor(180);
        doc.line(20, y, 190, y);
      }

      doc.setFont("helvetica", "bold");
      doc.setFontSize(18);
      doc.text("RESUMEN DE PQRS", 20, 20);

      const fecha = new Date().toLocaleDateString("es-CO", {
        year: "numeric",
        month: "long",
        day: "numeric"
      });

      doc.setFontSize(12);
      doc.text(`Fecha del reporte: ${fecha}`, 20, 30);

      // üî• Traer PQRS desde Google Sheets
      let pqrs = [];

      try {
        const res = await fetch(WEBAPP_URL);
        pqrs = await res.json();
      } catch (error) {
        alert("Error cargando PQRS desde Google Sheets.");
        return;
      }

      if (pqrs.length === 0) {
        doc.text("No hay PQRS registradas.", 20, 45);
        doc.save(`resumen_pqrs_${fecha}.pdf`);
        return;
      }

      let y = 50;

      pqrs.forEach((pqr, index) => {
        if (y > 260) {
          doc.addPage();
          y = 20;
        }

        doc.setFont("helvetica", "bold");
        doc.text(`${index + 1}. Usuario: ${pqr.nombre} ${pqr.apellido}`, 20, y);
        y += 8;

        doc.setFont("helvetica", "normal");
        doc.text(`Mensaje: ${pqr.mensaje}`, 25, y);
        y += 8;

        doc.text(`Fecha: ${pqr.fecha}`, 25, y);
        y += 10;

        line(y);
        y += 10;
      });

      doc.save(`resumen_pqrs_${fecha}.pdf`);
    });
  </script>

</body>
</html>
