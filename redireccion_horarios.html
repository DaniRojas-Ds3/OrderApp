<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Gestor de Temporizadores</title>

<script src="https://cdn.tailwindcss.com"></script>

<style>
body {
    margin: 0;
    padding: 0;
    font-family: 'Segoe UI', Tahoma, sans-serif;
    background: linear-gradient(135deg,#ffcf70,#fadda4);
    display: flex;
    justify-content: center;
    min-height: 100vh;
}
.contenedor {
    background: white;
    width: 95%;
    max-width: 900px;
    padding: 40px;
    margin: 40px 0;
    border-radius: 25px;
    box-shadow: 0 5px 25px rgba(0,0,0,.25);
}
</style>
</head>

<body>
<div class="contenedor">

    <!-- HEADER -->
    <div class="text-center mb-8">
        <div class="text-8xl mb-4 drop-shadow-xl">‚è±</div>
        <h1 class="text-3xl font-bold text-gray-700">
            Gestor de Temporizadores
        </h1>
    </div>

    <!-- FORMULARIO -->
    <div class="mt-6 border-2 border-red-300 rounded-xl p-4 bg-yellow-50">
        <input id="tokenInput" type="text" placeholder="Ficha"
            class="w-full p-3 border rounded-lg bg-white text-center text-lg">

        <button id="startButton"
            class="mt-3 w-full bg-red-600 text-white p-3 rounded-lg font-bold hover:bg-red-800 transition shadow-md">
            Iniciar Temporizador (30 min)
        </button>

        <button onclick="window.location.href='index.html'"
            class="mt-3 w-full bg-red-600 text-white p-3 rounded-lg font-bold hover:bg-red-800 transition shadow-md">
            Volver al inicio
        </button>
    </div>

    <!-- CONTADOR -->
    <h2 class="text-2xl font-bold text-gray-700 mt-10">
        Temporizadores Activos <span id="activeCount">(0/3)</span>
    </h2>

    <!-- CONTENEDOR -->
    <div id="activeTimersContainer"
        class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 mt-6">
    </div>

</div>

<script>
/* ================= CONFIG ================= */
const SCRIPT_URL =
"https://script.google.com/macros/s/AKfycbzkNqGYdWzvg1OTP19Qj1yCvj_lW_kVmm-3uZ-dwOBz9BOet5Ez1Jx1lMl1RRiwXlkx/exec";


const MAX_TIMERS = 3;

/* ================= ESTADO ================= */
let activeTimers = [];

/* ================= UTIL ================= */
function formatTime(ms) {
    const s = Math.max(0, Math.floor(ms / 1000));
    return `${String(Math.floor(s/60)).padStart(2,'0')}:${String(s%60).padStart(2,'0')}`;
}

function colorByTime(ms) {
    const min = ms / 60000;
    if (min > 20) return "bg-green-100 border-green-400";
    if (min > 10) return "bg-yellow-100 border-yellow-400";
    if (min > 5)  return "bg-orange-100 border-orange-400";
    return "bg-red-100 border-red-400";
}

/* ================= RENDER ================= */
function renderTimers() {
    const cont = document.getElementById("activeTimersContainer");
    cont.innerHTML = "";

    activeTimers.forEach(t => {
        const remaining = t.endTime - Date.now();
        if (remaining <= 0) return;

        const card = document.createElement("div");
        card.className = `p-5 rounded-xl border shadow text-center ${colorByTime(remaining)}`;

        card.innerHTML = `
            <p class="text-gray-600">Ficha</p>
            <p class="text-xl font-bold">${t.token}</p>
            <p class="text-3xl font-black mt-2">${formatTime(remaining)}</p>
        `;
        cont.appendChild(card);
    });

    document.getElementById("activeCount").textContent =
        `(${activeTimers.length}/${MAX_TIMERS})`;
}

/* ================= JSONP ================= */
function jsonp(url, callback) {
    const cb = "cb_" + Date.now();
    window[cb] = data => {
        callback(data);
        delete window[cb];
    };
    const s = document.createElement("script");
    s.src = `${url}&callback=${cb}`;
    document.body.appendChild(s);
}

/* ================= CARGAR ACTIVOS ================= */
function loadActiveTimers() {
    jsonp(`${SCRIPT_URL}?action=getActive`, data => {
        activeTimers = data || [];
        renderTimers();
    });
}

/* ================= INICIAR ================= */
function startTimer() {
    const token = document.getElementById("tokenInput").value.trim();
    if (!token) return alert("Ingrese una ficha");

    jsonp(
        `${SCRIPT_URL}?action=start&token=${encodeURIComponent(token)}`,
        data => {
            if (!data.success) {
                alert(data.message);
                return;
            }
            document.getElementById("tokenInput").value = "";
            loadActiveTimers();
        }
    );
}

document.getElementById("startButton").onclick = startTimer;

/* ================= INIT ================= */
loadActiveTimers();
setInterval(renderTimers, 1000);
</script>

</body>
</html>
